Title: kubernetes

"Kubernetes is an open-source platform for automating deployment, scaling, and operations of application containers across clusters of hosts, providing container-centric infrastructure." - <https://kubernetes.io/docs/whatisk8s>

# Glossary

More terms in the k8s glossary: <https://kubernetes.io/docs/reference/glossary/>

- Container Network Interface (CNI) - https://github.com/containernetworking/cni
- Container Runtime Interface (CRI) - https://github.com/containerd/cri/
- Container Storage Interface (CSI) - https://github.com/container-storage-interface/spec
- Horizontal Pod Autoscaling (HPA)

# cli usage

## Learn about kubernetes

```
kubectl explain roles
```

## Multiple kubeadm configs

The default config is `~/.kube/config`, but if you want to use multiple configs you can do this:

```
export KUBECONFIG="${HOME}/code/kubespray/artifacts/admin.conf:${HOME}/.kube/config"
```

I have seen weird problems when the order of configs is changed, such as `certificate-authority-data` and `client-certificate-data` being missing.

## kubeadm

"kubeadm: easily bootstrap a secure Kubernetes cluster." - `kubeadm --help`

- <https://github.com/kubernetes/kubeadm>

### Show your kubeadm tokens

```
$ sudo kubeadm token list
TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
ubyc9a.1eq2ihwtnz7c7c9e   23h       2018-05-24T16:19:33-04:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```

See `sudo kubeadm token -h` for more usage.

## kubectl

"kubectl controls the Kubernetes cluster manager." - `kubectl --help`

- <https://github.com/kubernetes/kubectl>

- `kubectl get` - show all resource types with short-hand versions.
- `kubectl completion -h` - show how to configure completion for your shell.
- `kubectl config get-contexts` - show which k8s configuration contexts you can control.
- `kubectl config use-context foo` - switch to the foo context.
- `kubectl get nodes` - show the nodes in the k8s cluster.
- `kubectl get pods` - show deployed pods. there can be many pods per deployment.
- `kubectl get pods -n kube-system` - show pods in a specific namespace.
- `kubectl get pods,hpa,deployment --all-namespaces` - get several resource types at once, from all namespaces
- `kubectl describe pod foo`
- `kubectl get deployment`
- `kubectl describe deployment foo`
- `kubectl get ns` - show namespaces.
- `kubectl get pv` - show physical volumes.
- `kubectl get svc -n kube-system` - show a table of important details about running services in the kube-system namespace.
- `kubectl get pods -o yaml` - show the yaml configs for the currently running status of every pod.
- `kubectl explain pods.spec` - show documentation about pod specifications.
- `kubectl describe pods/echoserver` - describe the pod whose `Name` is echoserver.
- `kubectl get rs` - show replica sets.
- `kubectl expose deployment <deployment_name> --type=NodePort` - create a service for the given deployment.
- `kubectl scale deployment <deployment_name> --replicas=5` - scale a deployment to 5 pods.
- `kubectl rollout history deployment <deployment_name>`
- `kubectl get cm` - get a list of config maps.


## Watch what's going on in your cluster

```
watch kubectl get pods --all-namespaces -o wide
```

## Show logs for a given pod since N hours ago

```
kubectl logs <podname> --since=12h
```

The `--since` arg can take [s]econds, [m]inutes and [h]ours. Longer durations should use `--since-time=<rfc3339 timestamp>`

## Show logs for a given pod since a given date

The `--since-time` arg takes [RFC3339](https://tools.ietf.org/html/rfc3339) datetime. EG: `1991-08-03T13:31:46-07:00`. This format requirement is strict, and is incompatible with the GNU date `--rfc-3339=seconds` output, which uses a space instead of a T to separate the full date from the full time, and `+%FT%F%z`, which does not include a colon between hours and minutes.

```
kubectl logs <pod_name> --since-time="$(date --iso-8601=seconds -d '-5 weeks')"
```

# Installations

The standard way to install k8s by yourself is to use `kubeadm`.

## Manually on Ubuntu 16

```
# as root
swapoff -a # https://github.com/kubernetes/kubernetes/issues/53533
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
echo "deb [arch=amd64] https://download.docker.com/linux/ubuntu xenial stable" > /etc/apt/sources.list.d/docker.list
echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" > /etc/apt/sources.list.d/kubernetes.list
apt update
apt dist-upgrade -y
apt install -y apt-transport-https ca-certificates curl software-properties-common
apt install -y docker-ce
apt install -y kubelet kubeadm kubectl
kubeadm init
```

`kubeadm init` guide: <https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#instructions>

# Links

- <http://on-demand.gputechconf.com/gtc/2018/presentation/s8893-the-path-to-gpu-as-a-service-in-kubernetes.pdf>
- <http://on-demand.gputechconf.com/gtc/2018/video/S8893/>
- <http://slack.kubernetes.io/>
- <https://blog.hypriot.com/post/setup-kubernetes-raspberry-pi-cluster>
- <https://docs.projectcalico.org/latest/introduction/>
- <https://github.com/kelseyhightower/kubernetes-the-hard-way> - "The target audience for this tutorial is someone planning to support a production Kubernetes cluster and wants to understand how everything fits together."
- <https://github.com/kinvolk/kubernetes-the-hard-way-vagrant> - "A port of Kelsey Hightower's 'Kubernetes the Hard Way' tutorial to Vagrant."
- <https://github.com/kubernetes/dashboard#kubernetes-dashboard>
- <https://github.com/kubernetes/kompose> - Compose to Kubernetes
- <https://kubernetes.io/docs/concepts/cluster-administration/addons/>
- <https://kubernetes.io/docs/concepts/cluster-administration/logging/>
- <https://kubernetes.io/docs/concepts/services-networking/network-policies/>
- <https://kubernetes.io/docs/concepts/workloads/controllers/deployment/>
- <https://kubernetes.io/docs/concepts/workloads/pods/pod/index.html>
- <https://kubernetes.io/docs/getting-started-guides/minikube/>
- <https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm>
- <https://www.cncf.io/certification/expert/CKA/>
- <https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-details>
- <https://github.com/ClusterHQ/flocker> - Flocker is an open-source Container Data Volume Manager for your Dockerized applications.
- <https://cloudplatform.googleblog.com/2018/05/Beyond-CPU-horizontal-pod-autoscaling-comes-to-Google-Kubernetes-Engine.html>
- <https://github.com/vapor-ware/ksync> - Sync local filesystem with a target container
